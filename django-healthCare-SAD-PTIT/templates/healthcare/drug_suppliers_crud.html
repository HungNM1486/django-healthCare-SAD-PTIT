<!-- Drug Suppliers Management Modal -->
<div class="modal fade" id="manageDrugSuppliersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Drug Suppliers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <h6 class="mb-0">Drug Supplier List</h6>
                    <button class="btn btn-sm btn-success" id="addNewDrugSupplierBtn">
                        <i class="fas fa-plus me-1"></i>Add New Supplier
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="drugSuppliersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact Person</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated with AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Drug Supplier Modal -->
<div class="modal fade" id="addDrugSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Drug Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDrugSupplierForm" action="/api/healthcare/drug-suppliers/" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Supplier Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" class="form-control" name="contact_person">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-control" name="website" placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addDrugSupplierForm" class="btn btn-primary">Save Supplier</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Drug Supplier Modal -->
<div class="modal fade" id="editDrugSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Drug Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDrugSupplierForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Supplier Name</label>
                        <input type="text" class="form-control" id="editDrugSupplierName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" class="form-control" id="editDrugSupplierContactPerson" name="contact_person">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editDrugSupplierEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="editDrugSupplierPhone" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="editDrugSupplierAddress" name="address" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-control" id="editDrugSupplierWebsite" name="website" placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="editDrugSupplierNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editDrugSupplierForm" class="btn btn-primary">Update Supplier</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Drug Supplier Confirmation Modal -->
<div class="modal fade" id="deleteDrugSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this drug supplier? This action cannot be undone and may affect existing medications associated with this supplier.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteDrugSupplier">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Open Manage Drug Suppliers Modal
        $("#manageDrugSuppliersBtn").click(function() {
            loadAllDrugSuppliers();
            $("#manageDrugSuppliersModal").modal('show');
        });
        
        // Load all drug suppliers 
        function loadAllDrugSuppliers() {
            $.ajax({
                url: '/api/healthcare/drug-suppliers/',
                type: 'GET',
                success: function(data) {
                    populateDrugSuppliersTable(data);
                },
                error: function() {
                    alert('Error loading drug suppliers data.');
                }
            });
        }
        
        // Populate drug suppliers table
        function populateDrugSuppliersTable(suppliers) {
            const table = $("#drugSuppliersTable tbody");
            table.empty();
            
            suppliers.forEach(function(supplier) {
                const row = `<tr>
                    <td>${supplier.name}</td>
                    <td>${supplier.contact_person || '-'}</td>
                    <td>${supplier.email}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.address.substring(0, 30)}${supplier.address.length > 30 ? '...' : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-edit-supplier" data-id="${supplier.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1 btn-delete-supplier" data-id="${supplier.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
                
                table.append(row);
            });
            
            // Attach event handlers to the newly created buttons
            attachDrugSupplierEventHandlers();
        }
        
        // Attach event handlers to drug supplier buttons
        function attachDrugSupplierEventHandlers() {
            // Add New Drug Supplier button
            $("#addNewDrugSupplierBtn").click(function() {
                $("#addDrugSupplierModal").modal('show');
                $("#manageDrugSuppliersModal").modal('hide');
            });
            
            // Edit Drug Supplier button
            $(".btn-edit-supplier").click(function() {
                const supplierId = $(this).data('id');
                
                // Fetch supplier data
                $.ajax({
                    url: `/api/healthcare/drug-suppliers/${supplierId}/`,
                    type: 'GET',
                    success: function(data) {
                        $("#editDrugSupplierForm").attr('action', `/api/healthcare/drug-suppliers/${supplierId}/`);
                        $("#editDrugSupplierName").val(data.name);
                        $("#editDrugSupplierContactPerson").val(data.contact_person);
                        $("#editDrugSupplierEmail").val(data.email);
                        $("#editDrugSupplierPhone").val(data.phone);
                        $("#editDrugSupplierAddress").val(data.address);
                        $("#editDrugSupplierWebsite").val(data.website);
                        $("#editDrugSupplierNotes").val(data.notes);
                        
                        $("#manageDrugSuppliersModal").modal('hide');
                        $("#editDrugSupplierModal").modal('show');
                    },
                    error: function() {
                        alert('Error loading drug supplier data.');
                    }
                });
            });
            
            // Delete Drug Supplier button
            $(".btn-delete-supplier").click(function() {
                const supplierId = $(this).data('id');
                $("#confirmDeleteDrugSupplier").data('id', supplierId);
                $("#manageDrugSuppliersModal").modal('hide');
                $("#deleteDrugSupplierModal").modal('show');
            });
        }
        
        // Add Drug Supplier form submission
        $("#addDrugSupplierForm").submit(function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    alert('Drug supplier added successfully!');
                    $('#addDrugSupplierModal').modal('hide');
                    loadAllDrugSuppliers();
                    $("#manageDrugSuppliersModal").modal('show');
                },
                error: function(xhr) {
                    alert('Error occurred. Please try again.');
                }
            });
        });
        
        // Edit Drug Supplier form submission
        $("#editDrugSupplierForm").submit(function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const url = $(this).attr('action');
            
            $.ajax({
                url: url,
                type: 'PUT',
                data: JSON.stringify(Object.fromEntries(formData)),
                contentType: 'application/json',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                },
                success: function(response) {
                    alert('Drug supplier updated successfully!');
                    $('#editDrugSupplierModal').modal('hide');
                    loadAllDrugSuppliers();
                    $("#manageDrugSuppliersModal").modal('show');
                },
                error: function(xhr) {
                    alert('Error occurred. Please try again.');
                }
            });
        });
        
        // Confirm Delete Drug Supplier
        $("#confirmDeleteDrugSupplier").click(function() {
            const supplierId = $(this).data('id');
            
            $.ajax({
                url: `/api/healthcare/drug-suppliers/${supplierId}/`,
                type: 'DELETE',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                },
                success: function() {
                    alert('Drug supplier deleted successfully!');
                    $('#deleteDrugSupplierModal').modal('hide');
                    loadAllDrugSuppliers();
                    $("#manageDrugSuppliersModal").modal('show');
                },
                error: function(xhr) {
                    if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.message) {
                        alert('Cannot delete: ' + xhr.responseJSON.message);
                    } else {
                        alert('Error occurred. Please try again.');
                    }
                    $('#deleteDrugSupplierModal').modal('hide');
                    $("#manageDrugSuppliersModal").modal('show');
                }
            });
        });

        // Modal chain handlers
        $('#addDrugSupplierModal').on('hidden.bs.modal', function() {
            $("#manageDrugSuppliersModal").modal('show');
        });

        $('#editDrugSupplierModal').on('hidden.bs.modal', function() {
            $("#manageDrugSuppliersModal").modal('show');
        });

        $('#deleteDrugSupplierModal').on('hidden.bs.modal', function() {
            $("#manageDrugSuppliersModal").modal('show');
        });
    });
</script>
